# -*- coding: utf-8 -*-
"""æ•´ç†ç‰ˆ dimensionality_reduction_utils.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1mH-6nt2ho-A2slQUWMHbbcKWJM0ch0Z0
"""

# ================================================
# dimensionality_reduction_utils.py
# æ¬¡å…ƒå‰Šæ¸›ã‚¿ã‚¹ã‚¯ç”¨ï¼šãƒ¢ãƒ‡ãƒ«å­¦ç¿’ãƒ»é©ç”¨ãƒ»ä¿å­˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
# ================================================

import pandas as pd
import numpy as np
import joblib
import logging
from typing import Any, Dict
from sklearn.decomposition import PCA
from sklearn.manifold import TSNE
from sklearn.preprocessing import StandardScaler

# ãƒ­ã‚°è¨­å®š
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")
logger = logging.getLogger(__name__)

# ================================================
# æ¬¡å…ƒå‰Šæ¸›ãƒ¢ãƒ‡ãƒ«å­¦ç¿’
# ================================================

def train_dimensionality_reduction(X: pd.DataFrame,
                                   method: str = "pca",
                                   params: Dict = None) -> Any:
    """
    æŒ‡å®šã•ã‚ŒãŸæ‰‹æ³•ã§æ¬¡å…ƒå‰Šæ¸›ãƒ¢ãƒ‡ãƒ«ã‚’å­¦ç¿’ã™ã‚‹é–¢æ•°
    """
    logger.info(f"ğŸ”„ æ¬¡å…ƒå‰Šæ¸›ãƒ¢ãƒ‡ãƒ«ï¼ˆ{method}ï¼‰å­¦ç¿’é–‹å§‹")

    if params is None:
        params = {}

    if method.lower() == "pca":
        default_params = {"n_components": 2}
        default_params.update(params)
        model = PCA(**default_params)

    elif method.lower() == "tsne":
        default_params = {"n_components": 2, "random_state": 42}
        default_params.update(params)
        model = TSNE(**default_params)

    else:
        logger.error(f"âŒ æœªå¯¾å¿œã®æ¬¡å…ƒå‰Šæ¸›æ‰‹æ³•: {method}")
        return None

    if method.lower() != "tsne":
        model.fit(X)
        logger.info("âœ… ãƒ¢ãƒ‡ãƒ«å­¦ç¿’å®Œäº†")
    else:
        logger.info("âœ… t-SNEã¯ fit_transform() ã§ç›´æ¥é©ç”¨ã•ã‚Œã¾ã™")

    return model

# ================================================
# æ¬¡å…ƒå‰Šæ¸›é©ç”¨
# ================================================

def apply_dimensionality_reduction(model: Any, X: pd.DataFrame, method: str = "pca") -> pd.DataFrame:
    """
    å­¦ç¿’æ¸ˆã¿æ¬¡å…ƒå‰Šæ¸›ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ã™ã‚‹é–¢æ•°
    """
    try:
        if method.lower() == "tsne":
            result = model.fit_transform(X)
        else:
            result = model.transform(X)

        return pd.DataFrame(result, columns=[f"{method.upper()}_{i+1}" for i in range(result.shape[1])])

    except Exception as e:
        logger.error(f"âŒ æ¬¡å…ƒå‰Šæ¸›é©ç”¨ã‚¨ãƒ©ãƒ¼: {e}")
        return pd.DataFrame()

# ================================================
# ãƒ¢ãƒ‡ãƒ«ä¿å­˜ãƒ»èª­è¾¼
# ================================================

def save_model(model: Any, path: str) -> None:
    """
    å­¦ç¿’æ¸ˆã¿æ¬¡å…ƒå‰Šæ¸›ãƒ¢ãƒ‡ãƒ«ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
    """
    try:
        joblib.dump(model, path)
        logger.info(f"âœ… ãƒ¢ãƒ‡ãƒ«ä¿å­˜å®Œäº†: {path}")
    except Exception as e:
        logger.error(f"âŒ ãƒ¢ãƒ‡ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}")

def load_model(path: str) -> Any:
    """
    ä¿å­˜ã•ã‚ŒãŸæ¬¡å…ƒå‰Šæ¸›ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
    """
    try:
        model = joblib.load(path)
        logger.info(f"âœ… ãƒ¢ãƒ‡ãƒ«èª­è¾¼å®Œäº†: {path}")
        return model
    except Exception as e:
        logger.error(f"âŒ ãƒ¢ãƒ‡ãƒ«èª­è¾¼ã‚¨ãƒ©ãƒ¼: {e}")
        return None