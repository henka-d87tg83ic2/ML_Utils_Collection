# -*- coding: utf-8 -*-
"""dimensionality_reduction_utils.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1wdBmdpMolVPBI4NHUqqFHUS0_DmkllD9

1. ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ»ç’°å¢ƒè¨­å®šï¼ˆãƒ­ã‚®ãƒ³ã‚°å«ã‚€ï¼‰
2. ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ãƒ»å‰å‡¦ç†ï¼ˆæ¨™æº–åŒ–ãƒ»ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼‰
3. æ¬¡å…ƒå‰Šæ¸›ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ é©ç”¨ï¼ˆPCA, t-SNE, UMAPå¯¾å¿œäºˆå®šï¼‰
4. çµæœã®å¯è¦–åŒ–ï¼ˆ2Dãƒ»3Dãƒ—ãƒ­ãƒƒãƒˆï¼‰
5. ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒ»èª­è¾¼ï¼ˆãƒ¢ãƒ‡ãƒ«ä¿å­˜ï¼‰
6. ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ”¯æ´
"""

# ================================
# ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¨ç’°å¢ƒè¨­å®š
# ================================

import os
import joblib
import logging
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import plotly.express as px
from sklearn.preprocessing import StandardScaler
from sklearn.decomposition import PCA
from sklearn.manifold import TSNE
try:
    import umap
    UMAP_AVAILABLE = True
except ImportError:
    UMAP_AVAILABLE = False

from google.colab import drive
from google.colab import files

from typing import Any, Dict, List, Optional, Tuple, Union

# ãƒ­ã‚°è¨­å®š
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")
logger = logging.getLogger(__name__)
# ================================
# ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ãƒ»å‰å‡¦ç†
# ================================

def load_csv_data(file_path: str, features_to_drop: Optional[List[str]] = None) -> pd.DataFrame:
    """CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰"""
    try:
        if not os.path.exists(file_path) and '/content/drive' not in file_path:
            file_path = os.path.join('/content/drive/MyDrive/', file_path)

        df = pd.read_csv(file_path)
        logger.info(f"ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å®Œäº†: {df.shape}")

        if features_to_drop:
            df = df.drop(columns=features_to_drop)

        return df
    except Exception as e:
        logger.error(f"âŒ CSVãƒ­ãƒ¼ãƒ‰å¤±æ•—: {e}")
        return None

def standardize_data(X: pd.DataFrame) -> pd.DataFrame:
    """ç‰¹å¾´é‡ã‚’æ¨™æº–åŒ–ï¼ˆå¹³å‡0ã€åˆ†æ•£1ï¼‰"""
    try:
        scaler = StandardScaler()
        X_scaled = scaler.fit_transform(X)
        logger.info("âœ… ç‰¹å¾´é‡æ¨™æº–åŒ–å®Œäº†")
        return pd.DataFrame(X_scaled, columns=X.columns)
    except Exception as e:
        logger.error(f"âŒ æ¨™æº–åŒ–å¤±æ•—: {e}")
        return None
# ================================
# æ¬¡å…ƒå‰Šæ¸›ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ é©ç”¨
# ================================

def apply_pca(X: pd.DataFrame, n_components: int = 2) -> np.ndarray:
    """PCAã«ã‚ˆã‚‹æ¬¡å…ƒå‰Šæ¸›"""
    try:
        pca = PCA(n_components=n_components)
        components = pca.fit_transform(X)
        logger.info(f"âœ… PCAæ¬¡å…ƒå‰Šæ¸›å®Œäº†ï¼ˆ{n_components}æ¬¡å…ƒï¼‰")
        return components
    except Exception as e:
        logger.error(f"âŒ PCAå¤±æ•—: {e}")
        return None

def apply_tsne(X: pd.DataFrame, n_components: int = 2, perplexity: int = 30, n_iter: int = 1000) -> np.ndarray:
    """t-SNEã«ã‚ˆã‚‹æ¬¡å…ƒå‰Šæ¸›"""
    try:
        tsne = TSNE(n_components=n_components, perplexity=perplexity, n_iter=n_iter, random_state=42)
        components = tsne.fit_transform(X)
        logger.info(f"âœ… t-SNEæ¬¡å…ƒå‰Šæ¸›å®Œäº†ï¼ˆ{n_components}æ¬¡å…ƒï¼‰")
        return components
    except Exception as e:
        logger.error(f"âŒ t-SNEå¤±æ•—: {e}")
        return None

def apply_umap(X: pd.DataFrame, n_components: int = 2) -> Optional[np.ndarray]:
    """UMAPã«ã‚ˆã‚‹æ¬¡å…ƒå‰Šæ¸›"""
    if not UMAP_AVAILABLE:
        logger.error("âŒ UMAPãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“")
        return None
    try:
        reducer = umap.UMAP(n_components=n_components, random_state=42)
        components = reducer.fit_transform(X)
        logger.info(f"âœ… UMAPæ¬¡å…ƒå‰Šæ¸›å®Œäº†ï¼ˆ{n_components}æ¬¡å…ƒï¼‰")
        return components
    except Exception as e:
        logger.error(f"âŒ UMAPå¤±æ•—: {e}")
        return None
# ================================
# æ¬¡å…ƒå‰Šæ¸›çµæœã®å¯è¦–åŒ–
# ================================

def plot_2d_components(components: np.ndarray, labels: Optional[np.ndarray] = None, title: str = "2D Plot") -> None:
    """2Dæ¬¡å…ƒå‰Šæ¸›çµæœã‚’ãƒ—ãƒ­ãƒƒãƒˆ"""
    try:
        df_plot = pd.DataFrame({
            "Dim1": components[:, 0],
            "Dim2": components[:, 1]
        })
        if labels is not None:
            df_plot["Label"] = labels
            fig = px.scatter(df_plot, x="Dim1", y="Dim2", color=df_plot["Label"].astype(str), title=title)
        else:
            fig = px.scatter(df_plot, x="Dim1", y="Dim2", title=title)
        fig.show()
    except Exception as e:
        logger.error(f"âŒ 2Dãƒ—ãƒ­ãƒƒãƒˆå¤±æ•—: {e}")

def plot_3d_components(components: np.ndarray, labels: Optional[np.ndarray] = None, title: str = "3D Plot") -> None:
    """3Dæ¬¡å…ƒå‰Šæ¸›çµæœã‚’ãƒ—ãƒ­ãƒƒãƒˆ"""
    try:
        df_plot = pd.DataFrame({
            "Dim1": components[:, 0],
            "Dim2": components[:, 1],
            "Dim3": components[:, 2]
        })
        if labels is not None:
            df_plot["Label"] = labels
            fig = px.scatter_3d(df_plot, x="Dim1", y="Dim2", z="Dim3", color=df_plot["Label"].astype(str), title=title)
        else:
            fig = px.scatter_3d(df_plot, x="Dim1", y="Dim2", z="Dim3", title=title)
        fig.show()
    except Exception as e:
        logger.error(f"âŒ 3Dãƒ—ãƒ­ãƒƒãƒˆå¤±æ•—: {e}")
# ================================
# ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒ»èª­è¾¼
# ================================

def save_model_to_drive(model: Any, relative_path: str) -> None:
    """æ¬¡å…ƒå‰Šæ¸›ãƒ¢ãƒ‡ãƒ«ã‚’Google Driveã«ä¿å­˜"""
    try:
        full_path = os.path.join('/content/drive/MyDrive/', relative_path)
        os.makedirs(os.path.dirname(full_path), exist_ok=True)
        joblib.dump(model, full_path)
        logger.info(f"âœ… ãƒ¢ãƒ‡ãƒ«ä¿å­˜å®Œäº†: {full_path}")
    except Exception as e:
        logger.error(f"âŒ ãƒ¢ãƒ‡ãƒ«ä¿å­˜å¤±æ•—: {e}")

def load_model_from_drive(relative_path: str) -> Any:
    """Google Driveã‹ã‚‰æ¬¡å…ƒå‰Šæ¸›ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰"""
    try:
        full_path = os.path.join('/content/drive/MyDrive/', relative_path)
        return joblib.load(full_path)
    except Exception as e:
        logger.error(f"âŒ ãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰å¤±æ•—: {e}")
        return None
# ================================
# ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ”¯æ´
# ================================

def upload_file_from_local() -> Dict[str, Any]:
    """ãƒ­ãƒ¼ã‚«ãƒ«PCã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"""
    logger.info("ğŸ“‚ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„")
    uploaded = files.upload()
    logger.info(f"âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†: {list(uploaded.keys())}")
    return uploaded