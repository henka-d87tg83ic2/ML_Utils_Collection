# -*- coding: utf-8 -*-
"""shap_utils.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1hkfchzNMNnMHjqHe25vlU-8AKMqbwBzb
"""

# ================================================
# shap_utils.py
# SHAPè§£æç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°é›†
# ================================================

import shap
import joblib
import pandas as pd
import matplotlib.pyplot as plt
import plotly.express as px
import os
import logging
from typing import Any, Optional, Union

# ãƒ­ã‚°è¨­å®š
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")
logger = logging.getLogger(__name__)

# ================================================
# SHAPå€¤è¨ˆç®—é–¢æ•°
# ================================================

def compute_shap_values(model: Any, X_sample: pd.DataFrame) -> shap.Explanation:
    """
    SHAPå€¤ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ã€‚ãƒ¢ãƒ‡ãƒ«ã®ç¨®é¡ã«å¿œã˜ã¦è‡ªå‹•ã§Explainerã‚’åˆæœŸåŒ–ã€‚

    Args:
        model (Any): å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ï¼ˆXGBoost, RandomForestãªã©ï¼‰
        X_sample (pd.DataFrame): SHAPè¨ˆç®—ã«ä½¿ã†å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ï¼ˆé€šå¸¸ã¯X_testï¼‰

    Returns:
        shap.Explanation: SHAPå€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    """
    try:
        logger.info("ğŸ” SHAP Explainer ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™...")
        if hasattr(model, "predict_proba"):
            explainer = shap.Explainer(model.predict_proba, X_sample)
        else:
            explainer = shap.Explainer(model, X_sample)

        shap_values = explainer(X_sample)
        logger.info("âœ… SHAPå€¤è¨ˆç®—å®Œäº†")
        return shap_values

    except Exception as e:
        logger.error(f"âŒ SHAPå€¤è¨ˆç®—ã‚¨ãƒ©ãƒ¼: {e}")
        return None

# ================================================
# SHAPå¯è¦–åŒ–é–¢æ•°ï¼ˆSummaryï¼Waterfallï¼‰
# ================================================

def plot_shap_summary(shap_values: shap.Explanation, features: pd.DataFrame) -> None:
    """
    SHAP Summary Plotã‚’æç”»ã™ã‚‹é–¢æ•°

    Args:
        shap_values (shap.Explanation): è¨ˆç®—æ¸ˆã¿ã®SHAPå€¤
        features (pd.DataFrame): å…¥åŠ›ç‰¹å¾´é‡ãƒ‡ãƒ¼ã‚¿
    """
    try:
        logger.info("ğŸ“ˆ SHAP Summary Plotã‚’æç”»ä¸­...")
        shap.summary_plot(shap_values.values, features)
        logger.info("âœ… Summary Plotæç”»å®Œäº†")
    except Exception as e:
        logger.error(f"âŒ Summary Plotæç”»ã‚¨ãƒ©ãƒ¼: {e}")


def plot_shap_waterfall(shap_values: shap.Explanation, row_index: int = 0) -> None:
    """
    æŒ‡å®šã‚µãƒ³ãƒ—ãƒ«ã®SHAP Waterfall Plotã‚’æç”»ã™ã‚‹é–¢æ•°

    Args:
        shap_values (shap.Explanation): è¨ˆç®—æ¸ˆã¿ã®SHAPå€¤
        row_index (int, optional): ãƒ—ãƒ­ãƒƒãƒˆã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ0ï¼‰
    """
    try:
        logger.info(f"ğŸ“ˆ SHAP Waterfall Plotã‚’æç”»ä¸­ï¼ˆã‚µãƒ³ãƒ—ãƒ« index={row_index}ï¼‰...")
        shap.plots.waterfall(shap_values[row_index])
        logger.info("âœ… Waterfall Plotæç”»å®Œäº†")
    except Exception as e:
        logger.error(f"âŒ Waterfall Plotæç”»ã‚¨ãƒ©ãƒ¼: {e}")

# ================================================
# SHAP 3Då¯è¦–åŒ–é–¢æ•°
# ================================================

def plot_shap_3d(shap_values: shap.Explanation,
                 X_sample: pd.DataFrame,
                 feature_x: str,
                 feature_y: str,
                 shap_feature: Optional[str] = None,
                 class_index: int = 0
                 ) -> None:
    """
    ç‰¹å¾´é‡2è»¸ Ã— SHAPå€¤ ã‚’3Dãƒ—ãƒ­ãƒƒãƒˆã™ã‚‹é–¢æ•°ï¼ˆplotlyï¼‰

    Args:
        shap_values (shap.Explanation): è¨ˆç®—æ¸ˆã¿ã®SHAPå€¤
        X_sample (pd.DataFrame): å…¥åŠ›ç‰¹å¾´é‡ãƒ‡ãƒ¼ã‚¿
        feature_x (str): Xè»¸ã«ã™ã‚‹ç‰¹å¾´é‡å
        feature_y (str): Yè»¸ã«ã™ã‚‹ç‰¹å¾´é‡å
        shap_feature (str, optional): Zè»¸ã«ã™ã‚‹ç‰¹å¾´é‡åï¼ˆæŒ‡å®šãªã—ã®å ´åˆã¯å¹³å‡SHAPå€¤ï¼‰
        class_index (int, optional): å¤šã‚¯ãƒ©ã‚¹åˆ†é¡æ™‚ã®å¯¾è±¡ã‚¯ãƒ©ã‚¹index
    """
    try:
        if shap_feature:
            shap_z = shap_values[:, :, class_index].values[:, X_sample.columns.get_loc(shap_feature)]
            title_z = shap_feature
        else:
            shap_z = shap_values[:, :, class_index].values.mean(axis=1)
            title_z = "SHAP mean"

        df_plot = pd.DataFrame({
            "X": X_sample[feature_x],
            "Y": X_sample[feature_y],
            "SHAP": shap_z
        })

        fig = px.scatter_3d(
            df_plot, x="X", y="Y", z="SHAP",
            color="SHAP", opacity=0.7,
            title=f"3D SHAP Plot: {feature_x} Ã— {feature_y} Ã— {title_z}"
        )
        fig.show()
        logger.info("âœ… 3D SHAP Plotæç”»å®Œäº†")

    except Exception as e:
        logger.error(f"âŒ 3D SHAPãƒ—ãƒ­ãƒƒãƒˆã‚¨ãƒ©ãƒ¼: {e}")

# ================================================
# SHAPå€¤ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿é–¢æ•°
# ================================================

def save_shap_values(shap_values: shap.Explanation, path: str) -> None:
    """
    SHAPå€¤ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã™ã‚‹é–¢æ•°ï¼ˆpklå½¢å¼ï¼‰

    Args:
        shap_values (shap.Explanation): ä¿å­˜ã™ã‚‹SHAPå€¤
        path (str): ä¿å­˜å…ˆãƒ‘ã‚¹
    """
    try:
        os.makedirs(os.path.dirname(path), exist_ok=True)
        joblib.dump(shap_values, path)
        logger.info(f"âœ… SHAPå€¤ä¿å­˜å®Œäº†: {path}")

    except Exception as e:
        logger.error(f"âŒ SHAPä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}")


def load_shap_values(path: str) -> Optional[shap.Explanation]:
    """
    ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰SHAPå€¤ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°

    Args:
        path (str): èª­ã¿è¾¼ã¿å…ƒãƒ‘ã‚¹

    Returns:
        shap.Explanation: èª­ã¿è¾¼ã‚“ã SHAPå€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    """
    try:
        shap_values = joblib.load(path)
        logger.info(f"âœ… SHAPå€¤èª­è¾¼å®Œäº†: {path}")
        return shap_values

    except Exception as e:
        logger.error(f"âŒ SHAPèª­è¾¼ã‚¨ãƒ©ãƒ¼: {e}")
        return None