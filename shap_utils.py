# -*- coding: utf-8 -*-
"""shap_utils.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1hkfchzNMNnMHjqHe25vlU-8AKMqbwBzb
"""

# ================================================
# shap_utils.py
# SHAPè§£æç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°é›†
# ================================================

import shap
import joblib
import pandas as pd
import matplotlib.pyplot as plt
import plotly.express as px
import os
import logging
from typing import Any, Optional, Union
import numpy as np


# ãƒ­ã‚°è¨­å®š
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")
logger = logging.getLogger(__name__)

# ================================================
# SHAPå€¤è¨ˆç®—é–¢æ•°
# ================================================

def compute_shap_values(model: Any, X_sample: pd.DataFrame) -> shap.Explanation:
    """
    SHAPå€¤ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ã€‚ãƒ¢ãƒ‡ãƒ«ã®ç¨®é¡ã«å¿œã˜ã¦è‡ªå‹•ã§Explainerã‚’åˆæœŸåŒ–ã€‚

    Args:
        model (Any): å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ï¼ˆXGBoost, RandomForestãªã©ï¼‰
        X_sample (pd.DataFrame): SHAPè¨ˆç®—ã«ä½¿ã†å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ï¼ˆé€šå¸¸ã¯X_testï¼‰

    Returns:
        shap.Explanation: SHAPå€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    """
    try:
        logger.info("ğŸ” SHAP Explainer ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™...")
        if hasattr(model, "predict_proba"):
            explainer = shap.Explainer(model.predict_proba, X_sample)
        else:
            explainer = shap.Explainer(model, X_sample)

        shap_values = explainer(X_sample)
        logger.info("âœ… SHAPå€¤è¨ˆç®—å®Œäº†")
        return shap_values

    except Exception as e:
        logger.error(f"âŒ SHAPå€¤è¨ˆç®—ã‚¨ãƒ©ãƒ¼: {e}")
        return None

# ================================================
# SHAPå¯è¦–åŒ–é–¢æ•°ï¼ˆSummaryï¼Waterfallï¼Interaction Heatmapï¼Decision Boundaryï¼‰
# ================================================

def plot_shap_summary(shap_values: shap.Explanation, features: pd.DataFrame) -> None:
    try:
        logger.info("ğŸ“ˆ SHAP Summary Plotã‚’æç”»ä¸­...")
        shap.summary_plot(shap_values.values, features)
        logger.info("âœ… Summary Plotæç”»å®Œäº†")
    except Exception as e:
        logger.error(f"âŒ Summary Plotæç”»ã‚¨ãƒ©ãƒ¼: {e}")


def plot_shap_waterfall(shap_values: shap.Explanation, row_index: int = 0) -> None:
    try:
        logger.info(f"ğŸ“ˆ SHAP Waterfall Plotã‚’æç”»ä¸­ï¼ˆã‚µãƒ³ãƒ—ãƒ« index={row_index}ï¼‰...")
        shap.plots.waterfall(shap_values[row_index])
        logger.info("âœ… Waterfall Plotæç”»å®Œäº†")
    except Exception as e:
        logger.error(f"âŒ Waterfall Plotæç”»ã‚¨ãƒ©ãƒ¼: {e}")


def plot_shap_interaction_heatmap_nodiag(
    interaction_matrix: np.ndarray,
    feature_names: list[str],
    title: str = "SHAP Interaction Heatmap (No Diagonal)",
    figsize: tuple = (12, 10),
    center: float = 0.0,
    vmin: float = None,
    vmax: float = None
) -> None:
    try:
        logger.info("ğŸ“Š SHAP Interaction Heatmapï¼ˆå¯¾è§’é™¤å¤–ï¼‰ã‚’æç”»ä¸­...")

        import numpy as np
        import matplotlib.pyplot as plt
        import seaborn as sns

        matrix_nodiag = interaction_matrix.copy()
        np.fill_diagonal(matrix_nodiag, 0)

        plt.figure(figsize=figsize)
        sns.heatmap(
            matrix_nodiag,
            xticklabels=feature_names,
            yticklabels=feature_names,
            cmap="Reds",
            center=center,
            vmin=vmin,
            vmax=vmax,
            square=True,
            linewidths=0.5,
            cbar_kws={"label": "Mean SHAP Interaction"}
        )
        plt.title(title, fontsize=16)
        plt.xticks(rotation=90)
        plt.yticks(rotation=0)
        plt.tight_layout()
        plt.show()

        logger.info("âœ… å¯¾è§’é™¤å¤–ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—æç”»å®Œäº†")
    except Exception as e:
        logger.error(f"âŒ å¯¾è§’é™¤å¤–ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—æç”»ã‚¨ãƒ©ãƒ¼: {e}")


def plot_shap_decision_boundary(
    model,
    explainer,
    X_scaled,
    shap_values,
    feature_x,
    feature_y,
    class_index=1,
    cmap_boundary="RdBu",
    cmap_shap="viridis",
    figsize=(10, 8),
    grid_resolution=100,
    title=None
) -> None:
    """
    æŒ‡å®šã—ãŸ2ç‰¹å¾´ã®ç©ºé–“ä¸Šã§æ±ºå®šå¢ƒç•Œã¨SHAPå€¤ã‚’é‡ã­ã¦å¯è¦–åŒ–ã™ã‚‹é–¢æ•°
    """
    try:
        logger.info(f"ğŸ“ˆ SHAP + æ±ºå®šå¢ƒç•Œã‚’å¯è¦–åŒ–ä¸­: {feature_x} Ã— {feature_y}")

        import numpy as np
        import matplotlib.pyplot as plt
        import pandas as pd

        fx_idx = X_scaled.columns.get_loc(feature_y)
        x_vals = np.linspace(X_scaled[feature_x].min(), X_scaled[feature_x].max(), grid_resolution)
        y_vals = np.linspace(X_scaled[feature_y].min(), X_scaled[feature_y].max(), grid_resolution)
        xx, yy = np.meshgrid(x_vals, y_vals)
        grid = pd.DataFrame(np.c_[xx.ravel(), yy.ravel()], columns=[feature_x, feature_y])

        X_mean = X_scaled.mean()
        for col in X_scaled.columns:
            if col not in [feature_x, feature_y]:
                grid[col] = X_mean[col]
        grid = grid[X_scaled.columns]  # åˆ—é †ã‚’ä¸€è‡´ã•ã›ã‚‹

        Z = model.predict_proba(grid)[:, class_index].reshape(xx.shape)

        shap_val = shap_values.values[:, fx_idx, class_index]
        df_plot = pd.DataFrame({
            feature_x: X_scaled[feature_x],
            feature_y: X_scaled[feature_y],
            "SHAP": shap_val
        })

        plt.figure(figsize=figsize)
        plt.contourf(xx, yy, Z, levels=20, cmap=cmap_boundary, alpha=0.6)
        sc = plt.scatter(df_plot[feature_x], df_plot[feature_y], c=df_plot["SHAP"], cmap=cmap_shap, edgecolor="k")
        plt.colorbar(sc, label="SHAP value")
        plt.xlabel(feature_x)
        plt.ylabel(feature_y)
        if title:
            plt.title(title)
        else:
            plt.title(f"SHAP + æ±ºå®šå¢ƒç•Œ: {feature_x} Ã— {feature_y}")
        plt.grid(True)
        plt.tight_layout()
        plt.show()

        logger.info("âœ… SHAP + æ±ºå®šå¢ƒç•Œã®é‡ã­æç”»å®Œäº†")
    except Exception as e:
        logger.error(f"âŒ æ±ºå®šå¢ƒç•Œå¯è¦–åŒ–ã‚¨ãƒ©ãƒ¼: {e}")

def plot_shap_meshgrid(
    shap_values: shap.Explanation,
    X_scaled: pd.DataFrame,
    feature_x: str,
    feature_y: str,
    class_index: int = 1,
    resolution: int = 100,
    cmap: str = "coolwarm",
    figsize: tuple = (10, 8),
    title: str = None
) -> None:
    """
    SHAPå€¤ã®2è»¸ãƒ¡ãƒƒã‚·ãƒ¥æ§‹é€ ã‚’ç­‰é«˜ç·šã§å¯è¦–åŒ–ã™ã‚‹é–¢æ•°
    """
    try:
        import numpy as np
        import matplotlib.pyplot as plt

        # å¯¾è±¡ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        fx_idx = X_scaled.columns.get_loc(feature_x)
        fy_idx = X_scaled.columns.get_loc(feature_y)

        # ãƒ‡ãƒ¼ã‚¿å–å¾—
        x = X_scaled[feature_x].values
        y = X_scaled[feature_y].values
        z = shap_values.values[:, fy_idx, class_index]  # Yè»¸ã«å¯¾å¿œã™ã‚‹SHAPå€¤

        # ãƒ¡ãƒƒã‚·ãƒ¥ã‚°ãƒªãƒƒãƒ‰ä½œæˆ
        xi = np.linspace(x.min(), x.max(), resolution)
        yi = np.linspace(y.min(), y.max(), resolution)
        xi, yi = np.meshgrid(xi, yi)

        # ã‚°ãƒªãƒƒãƒ‰è£œé–“
        from scipy.interpolate import griddata
        zi = griddata((x, y), z, (xi, yi), method='cubic')

        # æç”»
        plt.figure(figsize=figsize)
        contour = plt.contourf(xi, yi, zi, levels=20, cmap=cmap, alpha=0.8)
        sc = plt.scatter(x, y, c=z, cmap=cmap, edgecolor='k', s=40)
        plt.colorbar(contour, label='SHAP value')
        plt.xlabel(feature_x)
        plt.ylabel(feature_y)
        plt.title(title or f"SHAP 2Dãƒ¡ãƒƒã‚·ãƒ¥: {feature_x} Ã— {feature_y}")
        plt.grid(True)
        plt.tight_layout()
        plt.show()

        logger.info("âœ… SHAP ãƒ¡ãƒƒã‚·ãƒ¥ãƒ—ãƒ­ãƒƒãƒˆæç”»å®Œäº†")
    except Exception as e:
        logger.error(f"âŒ SHAPãƒ¡ãƒƒã‚·ãƒ¥æç”»ã‚¨ãƒ©ãƒ¼: {e}")


# ================================================
# SHAP 3Då¯è¦–åŒ–é–¢æ•°ï¼ˆæ‹¡å¼µç‰ˆï¼‰
# ================================================
def plot_shap_3d(shap_values, X_sample, feature_x, feature_y,
                 shap_feature=None, class_index=1,
                 width=1200, height=900, renderer="colab"):
    print("ğŸ“Š plot_shap_3d() å®Ÿè¡Œä¸­...")
    try:
        import pandas as pd
        import plotly.express as px
        import shap
        import numpy as np

        if isinstance(shap_values, shap.Explanation):
            values = shap_values.values
        else:
            values = shap_values

        if values.ndim == 3:
            values = values[:, :, class_index]

        if shap_feature:
            if shap_feature not in X_sample.columns:
                raise ValueError(f"æŒ‡å®šã•ã‚ŒãŸç‰¹å¾´å '{shap_feature}' ã¯ X_sample ã«å­˜åœ¨ã—ã¾ã›ã‚“ã€‚")
            feature_index = X_sample.columns.get_loc(shap_feature)
            shap_z = values[:, feature_index].flatten()
            title_z = shap_feature
        else:
            shap_z = values.mean(axis=1).flatten()
            title_z = "SHAP mean"

        df_plot = pd.DataFrame({
            "X": X_sample[feature_x].values.flatten(),
            "Y": X_sample[feature_y].values.flatten(),
            "SHAP": shap_z
        })

        fig = px.scatter_3d(
            df_plot, x="X", y="Y", z="SHAP",
            color="SHAP", opacity=0.7,
            title=f"3D SHAP Plot: {feature_x} Ã— {feature_y} Ã— {title_z}",
            color_continuous_scale="Greys_r"
        )

        fig.update_layout(
            width=width,
            height=height,
            paper_bgcolor="rgba(0,0,0,0)",  # å¤–æ ï¼šé€æ˜
            scene=dict(
                xaxis=dict(
                    title=feature_x,
                    showbackground=True,
                    backgroundcolor="burlywood",
                    gridcolor="white",
                    title_font=dict(size=22),
                    tickfont=dict(size=18)
                ),
                yaxis=dict(
                    title=feature_y,
                    showbackground=True,
                    backgroundcolor="burlywood",
                    gridcolor="white",
                    title_font=dict(size=22),
                    tickfont=dict(size=18)
                ),
                zaxis=dict(
                    title="SHAP Value",
                    showbackground=True,
                    backgroundcolor="burlywood",
                    gridcolor="white",
                    title_font=dict(size=22),
                    tickfont=dict(size=18)
                )
            )
        )

        fig.show(renderer=renderer)

    except Exception as e:
        print(f"âŒ 3D SHAPãƒ—ãƒ­ãƒƒãƒˆã‚¨ãƒ©ãƒ¼: {e}")

# ================================================
# SHAPå€¤ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿é–¢æ•°
# ================================================

def save_shap_values(shap_values: shap.Explanation, path: str) -> None:
    """
    SHAPå€¤ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã™ã‚‹é–¢æ•°ï¼ˆpklå½¢å¼ï¼‰

    Args:
        shap_values (shap.Explanation): ä¿å­˜ã™ã‚‹SHAPå€¤
        path (str): ä¿å­˜å…ˆãƒ‘ã‚¹
    """
    try:
        os.makedirs(os.path.dirname(path), exist_ok=True)
        joblib.dump(shap_values, path)
        logger.info(f"âœ… SHAPå€¤ä¿å­˜å®Œäº†: {path}")

    except Exception as e:
        logger.error(f"âŒ SHAPä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}")


def load_shap_values(path: str) -> Optional[shap.Explanation]:
    """
    ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰SHAPå€¤ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°

    Args:
        path (str): èª­ã¿è¾¼ã¿å…ƒãƒ‘ã‚¹

    Returns:
        shap.Explanation: èª­ã¿è¾¼ã‚“ã SHAPå€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    """
    try:
        shap_values = joblib.load(path)
        logger.info(f"âœ… SHAPå€¤èª­è¾¼å®Œäº†: {path}")
        return shap_values

    except Exception as e:
        logger.error(f"âŒ SHAPèª­è¾¼ã‚¨ãƒ©ãƒ¼: {e}")
        return None

# ================================================
# SHAP Interaction Heatmapï¼ˆæ˜ã‚‹ã•ï¼å¼·ã•ï¼‰
# ================================================
def plot_interaction_heatmap(
    interaction_matrix, feature_names, title="SHAP Interaction Heatmap",
    cmap="OrRd", figsize=(12, 10), linewidths=0.5, annot=False
):
    """
    SHAPç›¸äº’ä½œç”¨è¡Œåˆ—ã®ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’å¯è¦–åŒ–ã™ã‚‹é–¢æ•°ã€‚

    Parameters:
    ----------
    interaction_matrix : np.ndarray
        2æ¬¡å…ƒã® SHAP interaction å€¤ã®è¡Œåˆ—ï¼ˆå¹³å‡çµ¶å¯¾å€¤ã‚’å–ã£ãŸã‚‚ã®ã‚’æƒ³å®šï¼‰

    feature_names : list or pd.Index
        è¡Œåˆ—ã®å„è»¸ã«å¯¾å¿œã™ã‚‹ç‰¹å¾´å

    title : str
        ãƒ—ãƒ­ãƒƒãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«

    cmap : str
        è‰²ãƒãƒƒãƒ—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: "OrRd"ï¼‰

    figsize : tuple
        è¡¨ç¤ºã‚µã‚¤ã‚ºï¼ˆæ¨ª, ç¸¦ï¼‰

    linewidths : float
        ã‚»ãƒ«å¢ƒç•Œã®ç·šã®å¤ªã•

    annot : bool
        å„ã‚»ãƒ«ã«æ•°å€¤ã‚’è¡¨ç¤ºã™ã‚‹ã‹ï¼ˆTrueæ¨å¥¨ã¯å°è¦æ¨¡è¡Œåˆ—æ™‚ã®ã¿ï¼‰
    """
    print("ğŸ“Š plot_interaction_heatmap() å®Ÿè¡Œä¸­...")
    try:
        import matplotlib.pyplot as plt
        import seaborn as sns

        plt.figure(figsize=figsize)
        sns.heatmap(
            interaction_matrix,
            xticklabels=feature_names,
            yticklabels=feature_names,
            cmap=cmap,
            center=0,
            linewidths=linewidths,
            annot=annot
        )
        plt.title(f"{title}ï¼ˆæ˜ã‚‹ã•ï¼å¼·ã•ï¼‰", fontsize=14)
        plt.xticks(rotation=90)
        plt.yticks(rotation=0)
        plt.tight_layout()
        plt.show()

    except Exception as e:
        print(f"âŒ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—æç”»ã‚¨ãƒ©ãƒ¼: {e}")

