# -*- coding: utf-8 -*-
"""æ•´ç†ç‰ˆ anomaly_detection_utils.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/15Qz8KyQrsq-ICj3ja0jM_SjADQtLfvhM
"""

# ================================================
# anomaly_detection_utils.py
# ç•°å¸¸æ¤œçŸ¥ã‚¿ã‚¹ã‚¯ç”¨ï¼šãƒ¢ãƒ‡ãƒ«å­¦ç¿’ãƒ»ã‚¹ã‚³ã‚¢å‡ºåŠ›ãƒ»ä¿å­˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
# ================================================

import pandas as pd
import numpy as np
import joblib
import logging
from typing import Any, Dict
from sklearn.ensemble import IsolationForest
from sklearn.svm import OneClassSVM
from sklearn.metrics import classification_report

# ãƒ­ã‚°è¨­å®š
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")
logger = logging.getLogger(__name__)

# ================================================
# ç•°å¸¸æ¤œçŸ¥ãƒ¢ãƒ‡ãƒ«å­¦ç¿’
# ================================================

def train_anomaly_model(X: pd.DataFrame,
                        model_type: str = "isolation_forest",
                        params: Dict = None) -> Any:
    """
    æŒ‡å®šã•ã‚ŒãŸç•°å¸¸æ¤œçŸ¥ãƒ¢ãƒ‡ãƒ«ã‚’å­¦ç¿’ã™ã‚‹é–¢æ•°
    """
    logger.info(f"ğŸ”„ ç•°å¸¸æ¤œçŸ¥ãƒ¢ãƒ‡ãƒ«ï¼ˆ{model_type}ï¼‰å­¦ç¿’é–‹å§‹")

    if params is None:
        params = {}

    if model_type.lower() == "isolation_forest":
        default_params = {"n_estimators": 100, "contamination": 0.1, "random_state": 42}
        default_params.update(params)
        model = IsolationForest(**default_params)

    elif model_type.lower() == "one_class_svm":
        default_params = {"kernel": "rbf", "gamma": "scale", "nu": 0.05}
        default_params.update(params)
        model = OneClassSVM(**default_params)

    else:
        logger.error(f"âŒ æœªå¯¾å¿œã®ç•°å¸¸æ¤œçŸ¥ãƒ¢ãƒ‡ãƒ«: {model_type}")
        return None

    model.fit(X)
    logger.info("âœ… ãƒ¢ãƒ‡ãƒ«å­¦ç¿’å®Œäº†")
    return model

# ================================================
# ç•°å¸¸ã‚¹ã‚³ã‚¢ãƒ»è©•ä¾¡
# ================================================

def evaluate_anomaly_model(model: Any, X: pd.DataFrame, y_true: pd.Series) -> None:
    """
    ç•°å¸¸æ¤œçŸ¥ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹äºˆæ¸¬ã¨è©•ä¾¡ã‚’è¡Œã†é–¢æ•°ï¼ˆy_trueã¯1:æ­£å¸¸, -1:ç•°å¸¸ï¼‰
    """
    try:
        y_pred = model.predict(X)
        logger.info("ğŸ“Š Classification Report:")
        logger.info("\n" + classification_report(y_true, y_pred))

    except Exception as e:
        logger.error(f"âŒ ç•°å¸¸æ¤œçŸ¥è©•ä¾¡ã‚¨ãƒ©ãƒ¼: {e}")

# ================================================
# ãƒ¢ãƒ‡ãƒ«ä¿å­˜ãƒ»èª­è¾¼
# ================================================

def save_model(model: Any, path: str) -> None:
    """
    å­¦ç¿’æ¸ˆã¿ç•°å¸¸æ¤œçŸ¥ãƒ¢ãƒ‡ãƒ«ã‚’ä¿å­˜
    """
    try:
        joblib.dump(model, path)
        logger.info(f"âœ… ãƒ¢ãƒ‡ãƒ«ä¿å­˜å®Œäº†: {path}")
    except Exception as e:
        logger.error(f"âŒ ãƒ¢ãƒ‡ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}")

def load_model(path: str) -> Any:
    """
    ç•°å¸¸æ¤œçŸ¥ãƒ¢ãƒ‡ãƒ«ã®èª­è¾¼
    """
    try:
        model = joblib.load(path)
        logger.info(f"âœ… ãƒ¢ãƒ‡ãƒ«èª­è¾¼å®Œäº†: {path}")
        return model
    except Exception as e:
        logger.error(f"âŒ ãƒ¢ãƒ‡ãƒ«èª­è¾¼ã‚¨ãƒ©ãƒ¼: {e}")
        return None